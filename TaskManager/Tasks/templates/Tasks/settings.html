{% extends "Tasks/base.html" %}

{% block title %}Settings - TaskManager{% endblock %}

{% block body %}
    <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Header -->
        <div class="mb-8">
            <h1 class="text-4xl font-bold text-gray-900">Settings</h1>
            <p class="text-gray-600 mt-2">Manage your account</p>
        </div>

        <!-- Alert Messages -->
        {% if message %}
            <div class="mb-6 p-4 rounded-lg border 
                {% if message_type == 'success' %}
                    bg-green-50 border-green-200
                {% else %}
                    bg-red-50 border-red-200
                {% endif %}
            ">
                <p class="
                    {% if message_type == 'success' %}
                        text-green-700
                    {% else %}
                        text-red-700
                    {% endif %}
                ">
                    {{ message }}
                </p>
            </div>
        {% endif %}

        <div class="grid grid-cols-1 lg:grid-cols-4 gap-8">
            <!-- Sidebar Navigation -->
            <div class="lg:col-span-1">
                <div class="bg-white rounded-lg shadow sticky top-24">
                    <nav class="space-y-2 p-4">
                        <a href="#profile" class="block px-4 py-2 rounded-lg bg-blue-50 text-blue-600 font-medium transition">
                            <i class="fas fa-user mr-2"></i>Profile
                        </a>
                        <a href="#password" class="block px-4 py-2 rounded-lg text-gray-700 hover:bg-gray-50 font-medium transition">
                            <i class="fas fa-lock mr-2"></i>Password
                        </a>
                        <a href="#teams" class="block px-4 py-2 rounded-lg text-gray-700 hover:bg-gray-50 font-medium transition">
                            <i class="fas fa-users mr-2"></i>Teams
                        </a>
                        <a href="#notifications" class="block px-4 py-2 rounded-lg text-gray-700 hover:bg-gray-50 font-medium transition">
                            <i class="fas fa-bell mr-2"></i>Notifications
                        </a>
                    </nav>
                </div>
            </div>

            <!-- Main Content -->
            <div class="lg:col-span-3 space-y-6">
                <!-- Profile Section -->
                <div id="profile" class="bg-white rounded-lg shadow p-6 scroll-mt-20">
                    <div class="mb-6">
                        <h2 class="text-2xl font-bold text-gray-900 flex items-center">
                            <i class="fas fa-user text-blue-600 mr-3"></i> Profile Information
                        </h2>
                        <p class="text-gray-600 text-sm mt-1">Update your personal information</p>
                    </div>

                    <form method="post" class="space-y-5">
                        {% csrf_token %}
                        <input type="hidden" name="action" value="update_profile">

                        <!-- Avatar Section -->
                        <div class="flex items-center space-x-6 pb-6 border-b border-gray-200">
                            <div class="w-20 h-20 rounded-full bg-gradient-to-r from-blue-500 to-indigo-500 flex items-center justify-center text-white text-3xl font-bold">
                                {{ user.username|first|upper }}
                            </div>
                            <div>
                                <p class="font-semibold text-gray-900">{{ user.username }}</p>
                                <p class="text-gray-600 text-sm">Member since {{ user.date_joined|date:"F Y" }}</p>
                            </div>
                        </div>

                        <!-- Form Fields -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                            <!-- Username (Read-only) -->
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">
                                    Username
                                </label>
                                <input 
                                    type="text" 
                                    value="{{ user.username }}"
                                    disabled
                                    class="w-full px-4 py-2 bg-gray-100 text-gray-700 rounded-lg border border-gray-300 cursor-not-allowed"
                                >
                            </div>

                            <!-- First Name -->
                            <div>
                                <label for="first_name" class="block text-sm font-semibold text-gray-700 mb-2">
                                    First Name
                                </label>
                                <input 
                                    type="text" 
                                    id="first_name"
                                    name="first_name"
                                    value="{{ user.first_name }}"
                                    class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 outline-none transition"
                                    placeholder="Enter first name"
                                >
                            </div>

                            <!-- Last Name -->
                            <div>
                                <label for="last_name" class="block text-sm font-semibold text-gray-700 mb-2">
                                    Last Name
                                </label>
                                <input 
                                    type="text" 
                                    id="last_name"
                                    name="last_name"
                                    value="{{ user.last_name }}"
                                    class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 outline-none transition"
                                    placeholder="Enter last name"
                                >
                            </div>

                            <!-- Email -->
                            <div>
                                <label for="email" class="block text-sm font-semibold text-gray-700 mb-2">
                                    Email Address
                                </label>
                                <input 
                                    type="email" 
                                    id="email"
                                    name="email"
                                    value="{{ user.email }}"
                                    class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 outline-none transition"
                                    placeholder="Enter email address"
                                >
                            </div>
                        </div>

                        <!-- Save Button -->
                        <div class="pt-4 flex justify-end">
                            <button 
                                type="submit" 
                                class="px-8 py-2 bg-gradient-to-r from-green-400 to-blue-500 hover:from-green-500 hover:to-blue-600 text-white font-bold rounded-lg shadow-lg transition duration-200 transform hover:scale-105 flex items-center text-lg tracking-wide"
                            >
                                <i class="fas fa-save mr-2"></i>Save Changes
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Password Section -->
                <div id="password" class="bg-white rounded-lg shadow p-6 scroll-mt-20">
                    <div class="mb-6">
                        <h2 class="text-2xl font-bold text-gray-900 flex items-center">
                            <i class="fas fa-lock text-blue-600 mr-3"></i> Change Password
                        </h2>
                        <p class="text-gray-600 text-sm mt-1">Update your password to keep your account secure</p>
                    </div>

                    <form method="post" class="space-y-5 max-w-md">
                        {% csrf_token %}
                        <input type="hidden" name="action" value="change_password">

                        <!-- Current Password -->
                        <div>
                            <label for="current_password" class="block text-sm font-semibold text-gray-700 mb-2">
                                Current Password
                            </label>
                            <input 
                                type="password" 
                                id="current_password"
                                name="current_password"
                                required
                                class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 outline-none transition"
                                placeholder="Enter current password"
                            >
                        </div>

                        <!-- New Password -->
                        <div>
                            <label for="new_password" class="block text-sm font-semibold text-gray-700 mb-2">
                                New Password
                            </label>
                            <input 
                                type="password" 
                                id="new_password"
                                name="new_password"
                                required
                                class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 outline-none transition"
                                placeholder="Enter new password"
                            >
                            <p class="text-xs text-gray-600 mt-2">At least 8 characters recommended</p>
                        </div>

                        <!-- Confirm Password -->
                        <div>
                            <label for="confirm_password" class="block text-sm font-semibold text-gray-700 mb-2">
                                Confirm New Password
                            </label>
                            <input 
                                type="password" 
                                id="confirm_password"
                                name="confirm_password"
                                required
                                class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 outline-none transition"
                                placeholder="Confirm new password"
                            >
                        </div>

                        <!-- Update Button -->
                        <button 
                            type="submit" 
                            class="w-full px-4 py-2 bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 text-white font-semibold rounded-lg transition duration-200 transform hover:scale-105"
                        >
                            <i class="fas fa-key mr-2"></i>Update Password
                        </button>
                    </form>
                </div>

                <!-- Teams Section -->
                <div id="teams" class="bg-white rounded-lg shadow p-6 scroll-mt-20">
                    <div class="mb-6">
                        <h2 class="text-2xl font-bold text-gray-900 flex items-center">
                            <i class="fas fa-users text-blue-600 mr-3"></i> Teams
                        </h2>
                        <p class="text-gray-600 text-sm mt-1">Manage your team memberships</p>
                    </div>

                    <div class="space-y-4">
                        <!-- Managed Teams -->
                        {% if managed_teams %}
                            <div>
                                <h3 class="font-semibold text-gray-900 mb-3 text-sm">Teams You Manage</h3>
                                <div class="space-y-3">
                                    {% for team in managed_teams %}
                                        <div class="border border-gray-200 rounded-lg p-4 hover:border-blue-300 transition">
                                            <div class="flex items-center justify-between mb-3">
                                                <div>
                                                    <p class="font-semibold text-gray-900">{{ team.name }}</p>
                                                    <p class="text-sm text-gray-600 mt-1">{{ team.members.count }} member(s)</p>
                                                </div>
                                                <span class="inline-block px-3 py-1 bg-blue-100 text-blue-800 text-xs font-semibold rounded-full">Admin</span>
                                            </div>
                                            <!-- Team Members List -->
                                            <div class="mb-3">
                                                <p class="font-semibold text-gray-700 text-xs mb-1">Members:</p>
                                                <ul class="space-y-1">
                                                    {% for member in team.members.all %}
                                                        <li class="flex items-center justify-between text-sm">
                                                            <span>{{ member.username }}{% if member == team.admin %} <span class="text-blue-500 font-bold">(admin)</span>{% endif %}</span>
                                                            {% if member != team.admin %}
                                                                <form method="post" style="display:inline;" onsubmit="return confirm('Remove {{ member.username }} from {{ team.name }}?');">
                                                                    {% csrf_token %}
                                                                    <input type="hidden" name="action" value="remove_member">
                                                                    <input type="hidden" name="team_id" value="{{ team.id }}">
                                                                    <input type="hidden" name="user_id" value="{{ member.id }}">
                                                                    <button type="submit" class="text-red-500 hover:underline text-xs ml-2">Remove</button>
                                                                </form>
                                                            {% endif %}
                                                        </li>
                                                    {% endfor %}
                                                </ul>
                                            </div>
                                            <!-- Invite Member Form -->
                                            <div class="border-t border-gray-200 pt-3 mt-3">
                                                <form method="post" class="space-y-3">
                                                    {% csrf_token %}
                                                    <input type="hidden" name="action" value="invite_member">
                                                    <input type="hidden" name="team_id" value="{{ team.id }}">
                                                    <div class="flex gap-2">
                                                        <input 
                                                            type="email" 
                                                            name="invite_email" 
                                                            placeholder="Enter email to invite"
                                                            class="flex-1 px-3 py-2 rounded border border-gray-300 focus:border-blue-500 focus:ring-1 focus:ring-blue-500 outline-none text-sm"
                                                            required
                                                        >
                                                        <button 
                                                            type="submit"
                                                            class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium rounded transition"
                                                        >
                                                            <i class="fas fa-envelope mr-1"></i>Invite
                                                        </button>
                                                    </div>
                                                </form>
                                            </div>
                                            <!-- Rename/Delete Team -->
                                            <div class="flex gap-2 mt-4">
                                                <form method="post" onsubmit="return confirm('Rename team {{ team.name }}?');">
                                                    {% csrf_token %}
                                                    <input type="hidden" name="action" value="rename_team">
                                                    <input type="hidden" name="team_id" value="{{ team.id }}">
                                                    <input type="text" name="new_name" value="{{ team.name }}" class="px-2 py-1 border rounded text-sm" required />
                                                    <button type="submit" class="px-2 py-1 bg-blue-500 text-white rounded text-xs ml-1">Rename</button>
                                                </form>
                                                <form method="post" onsubmit="return confirm('Delete team {{ team.name }}? This cannot be undone.');">
                                                    {% csrf_token %}
                                                    <input type="hidden" name="action" value="delete_team">
                                                    <input type="hidden" name="team_id" value="{{ team.id }}">
                                                    <button type="submit" class="px-2 py-1 bg-red-500 text-white rounded text-xs">Delete</button>
                                                </form>
                                            </div>
                                        </div>
                                    {% endfor %}
                                </div>
                            </div>
                        {% endif %}

                        <!-- Member Teams -->
                        {% if user_teams %}
                            <div>
                                <h3 class="font-semibold text-gray-900 mb-3 text-sm">Teams You're In</h3>
                                <div class="space-y-3">
                                    {% for team in user_teams %}
                                        <div class="border border-gray-200 rounded-lg p-4 hover:border-blue-300 transition">
                                            <div class="flex items-center justify-between">
                                                <div>
                                                    <p class="font-semibold text-gray-900">{{ team.name }}</p>
                                                    <p class="text-sm text-gray-600 mt-1">{{ team.members.count }} member(s)</p>
                                                </div>
                                                <span class="inline-block px-3 py-1 bg-gray-100 text-gray-800 text-xs font-semibold rounded-full">Member</span>
                                            </div>
                                            <!-- Leave Team -->
                                            <form method="post" class="mt-2" onsubmit="return confirm('Leave team {{ team.name }}?');">
                                                {% csrf_token %}
                                                <input type="hidden" name="action" value="leave_team">
                                                <input type="hidden" name="team_id" value="{{ team.id }}">
                                                <button type="submit" class="px-2 py-1 bg-yellow-500 text-white rounded text-xs">Leave Team</button>
                                            </form>
                                        </div>
                                    {% endfor %}
                                </div>
                            </div>
                        {% endif %}

                        <!-- No Teams -->
                        {% if not managed_teams and not user_teams %}
                            <div class="text-center py-8 border border-dashed border-gray-300 rounded-lg">
                                <i class="fas fa-users text-4xl text-gray-300 mb-3"></i>
                                <p class="text-gray-600">You haven't joined any teams yet</p>
                            </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Notifications Section -->
                <div id="notifications" class="bg-white rounded-lg shadow p-6 scroll-mt-20">
                    <div class="mb-6">
                        <h2 class="text-2xl font-bold text-gray-900 flex items-center">
                            <i class="fas fa-bell text-blue-600 mr-3"></i> Notifications
                        </h2>
                        <p class="text-gray-600 text-sm mt-1">Control how you receive notifications</p>
                    </div>

                    <div class="space-y-4">
                        <!-- Email Notifications -->
                        <div class="flex items-center justify-between p-4 border border-gray-200 rounded-lg">
                            <div>
                                <p class="font-semibold text-gray-900">Email Notifications</p>
                                <p class="text-sm text-gray-600 mt-1">Receive updates via email</p>
                            </div>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" class="sr-only peer" checked>
                                <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                            </label>
                        </div>

                        <!-- Task Assignment Notifications -->
                        <div class="flex items-center justify-between p-4 border border-gray-200 rounded-lg">
                            <div>
                                <p class="font-semibold text-gray-900">Task Assignments</p>
                                <p class="text-sm text-gray-600 mt-1">When a task is assigned to you</p>
                            </div>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" class="sr-only peer" checked>
                                <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                            </label>
                        </div>

                        <!-- Comments Notifications -->
                        <div class="flex items-center justify-between p-4 border border-gray-200 rounded-lg">
                            <div>
                                <p class="font-semibold text-gray-900">Task Comments</p>
                                <p class="text-sm text-gray-600 mt-1">When someone comments on your tasks</p>
                            </div>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" class="sr-only peer" checked>
                                <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                            </label>
                        </div>
                    </div>
                </div>


                <!-- Danger Zone -->
                <div class="bg-red-50 border border-red-200 rounded-lg p-6">
                    <div class="mb-4">
                        <h2 class="text-2xl font-bold text-red-900 flex items-center">
                            <i class="fas fa-exclamation-triangle text-red-600 mr-3"></i> Danger Zone
                        </h2>
                        <p class="text-red-700 text-sm mt-1">Irreversible actions</p>
                    </div>

                    <div class="space-y-3">
                        <form method="post" onsubmit="return confirm('Are you sure you want to delete your account? This action cannot be undone.');">
                            {% csrf_token %}
                            <input type="hidden" name="action" value="delete_account">
                            <button type="submit" class="w-full px-4 py-2 bg-red-600 hover:bg-red-700 text-white font-semibold rounded-lg transition">
                                <i class="fas fa-trash mr-2"></i>Delete Account
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}
