{% extends "Tasks/base.html" %}

{% block title %}{{ task.title }} - TaskManager{% endblock %}

{% block body %}
    <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Header -->
        <div class="mb-8">
            <a href="{% url 'project_tasks' task.project.id %}" class="text-blue-600 hover:text-blue-700 mb-2 inline-block">
                <i class="fas fa-arrow-left mr-1"></i>{{ task.project.name }}
            </a>
            <div class="flex items-center justify-between">
                <h1 class="text-4xl font-bold text-gray-900">{{ task.title }}</h1>
                <div class="space-x-2">
                    <a href="{% url 'edit_task' task.id %}" class="inline-block px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-lg transition">
                        <i class="fas fa-edit mr-1"></i>Edit
                    </a>
                    <a href="{% url 'delete_task' task.id %}" class="inline-block px-4 py-2 bg-red-600 hover:bg-red-700 text-white font-semibold rounded-lg transition">
                        <i class="fas fa-trash mr-1"></i>Delete
                    </a>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Main Content -->
            <div class="lg:col-span-2 space-y-6">
                <!-- Description -->
                <div class="bg-white rounded-lg shadow p-6">
                    <h2 class="text-xl font-bold text-gray-900 mb-4">Description</h2>
                    <p class="text-gray-700 whitespace-pre-line">{{ task.description|default:"No description" }}</p>
                </div>

                <!-- Subtasks -->
                <div class="bg-white rounded-lg shadow p-6">
                    {% if task.all_subtasks_completed %}
                        <div class="mb-4 p-3 rounded bg-green-50 border border-green-200 text-green-800 flex items-center gap-2">
                            <i class="fas fa-check-circle"></i>
                            All subtasks completed. Task automatically marked as completed.
                        </div>
                    {% endif %}
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-xl font-bold text-gray-900">Subtasks</h2>
                        <form method="post" class="flex gap-2">
                            {% csrf_token %}
                            <input 
                                type="hidden" 
                                name="action" 
                                value="add_subtask"
                            >
                            <input 
                                type="text" 
                                name="title" 
                                placeholder="Add subtask..." 
                                class="flex-1 px-3 py-2 rounded border border-gray-300 focus:border-blue-500 focus:ring-1 focus:ring-blue-500 outline-none text-sm"
                            >
                            <button type="submit" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium rounded transition">
                                <i class="fas fa-plus"></i>
                            </button>
                        </form>
                    </div>

                    {% if subtasks %}
                        <div class="space-y-2">
                            {% for subtask in subtasks %}
                                <form method="post" class="flex items-center gap-3 p-3 hover:bg-gray-50 rounded transition">
                                    {% csrf_token %}
                                    <input type="hidden" name="action" value="toggle_subtask">
                                    <input 
                                        type="hidden" 
                                        name="subtask_id" 
                                        value="{{ subtask.id }}"
                                    >
                                    <input 
                                        type="checkbox" 
                                        {% if subtask.is_completed %}checked{% endif %}
                                        onchange="this.form.submit()"
                                        class="w-4 h-4 rounded"
                                    >
                                    <span class="{% if subtask.is_completed %}line-through text-gray-400{% else %}text-gray-900{% endif %}">
                                        {{ subtask.title }}
                                    </span>
                                </form>
                            {% endfor %}
                        </div>
                    {% else %}
                        <p class="text-gray-500 text-center py-4">No subtasks yet</p>
                    {% endif %}
                </div>

                <!-- Comments -->
                <div class="bg-white rounded-lg shadow p-6">
                    <h2 class="text-xl font-bold text-gray-900 mb-4">Comments ({{ comments.count }})</h2>

                    <!-- Add Comment -->
                    <form method="post" class="mb-6">
                        {% csrf_token %}
                        <input type="hidden" name="action" value="add_comment">
                        <div class="space-y-3">
                            {{ comment_form.content }}
                            {% if comment_form.content.errors %}
                                <p class="text-red-600 text-sm mt-1">{{ comment_form.content.errors.0 }}</p>
                            {% endif %}
                            <button type="submit" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded transition">
                                <i class="fas fa-comment mr-1"></i>Post Comment
                            </button>
                        </div>
                    </form>

                    <!-- Comments List -->
                    <div class="space-y-4">
                        {% if comments %}
                            {% for comment in comments %}
                                <div class="border border-gray-200 rounded-lg p-4">
                                    <div class="flex items-start justify-between mb-2">
                                        <div class="flex items-center gap-2">
                                            <div class="w-8 h-8 rounded-full bg-gradient-to-r from-blue-500 to-indigo-500 flex items-center justify-center text-white text-xs font-bold">
                                                {{ comment.author.username|first|upper }}
                                            </div>
                                            <span class="font-semibold text-gray-900">{{ comment.author.username }}</span>
                                        </div>
                                        <div class="flex items-center gap-2">
                                            <span class="text-xs text-gray-600">{{ comment.created_at|timesince }} ago</span>
                                            {% if user == comment.author or user == task.project.team.admin %}
                                                <a href="{% url 'edit_comment' comment.id %}" class="text-blue-600 hover:text-blue-800 text-xs font-semibold ml-2"><i class="fas fa-edit mr-1"></i>Edit</a>
                                                <form method="post" action="{% url 'delete_comment' comment.id %}" style="display:inline;">
                                                    {% csrf_token %}
                                                    <button type="submit" class="text-red-600 hover:text-red-800 text-xs font-semibold ml-2" onclick="return confirm('Are you sure you want to delete this comment?');"><i class="fas fa-trash mr-1"></i>Delete</button>
                                                </form>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <p class="text-gray-700">{{ comment.content }}</p>
                                </div>
                            {% endfor %}
                        {% else %}
                            <p class="text-gray-500 text-center py-4">No comments yet</p>
                        {% endif %}
                    </div>
                </div>

                <!-- Activity Log -->
                <div class="bg-white rounded-lg shadow p-6">
                    <h2 class="text-xl font-bold text-gray-900 mb-4">Activity</h2>
                    <div class="space-y-3">
                        {% if activity %}
                            {% for log in activity %}
                                <div class="flex items-start gap-3 pb-3 border-b border-gray-200 last:border-b-0">
                                    <div class="w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center flex-shrink-0">
                                        <i class="fas fa-history text-blue-600 text-sm"></i>
                                    </div>
                                    <div>
                                        <p class="text-sm text-gray-900"><span class="font-semibold">{{ log.user.username }}</span> {{ log.description|lower }}</p>
                                        <p class="text-xs text-gray-600">{{ log.created_at|timesince }} ago</p>
                                    </div>
                                </div>
                            {% endfor %}
                        {% else %}
                            <p class="text-gray-500 text-center py-4">No activity yet</p>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Sidebar -->
            <div class="space-y-6">
                <!-- Status -->
                <div class="bg-white rounded-lg shadow p-6">
                    <h3 class="text-sm font-semibold text-gray-700 uppercase mb-3">Status</h3>
                    <form method="post" class="space-y-2">
                        {% csrf_token %}
                        <input type="hidden" name="action" value="update_status">
                        <select 
                            name="status" 
                            onchange="this.form.submit()"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:border-blue-500 focus:ring-2 focus:ring-blue-200 outline-none"
                        >
                            {% for value, label in task_statuses %}
                                <option value="{{ value }}" {% if task.status == value %}selected{% endif %}>{{ label }}</option>
                            {% endfor %}
                        </select>
                    </form>
                    <p class="text-xs text-gray-600 mt-2">Current: <span class="font-semibold text-gray-900">{{ task.get_status_display }}</span></p>
                </div>

                <!-- Priority -->
                <div class="bg-white rounded-lg shadow p-6">
                    <h3 class="text-sm font-semibold text-gray-700 uppercase mb-3">Priority</h3>
                    <form method="post" class="space-y-2">
                        {% csrf_token %}
                        <input type="hidden" name="action" value="update_priority">
                        <select 
                            name="priority" 
                            onchange="this.form.submit()"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:border-blue-500 focus:ring-2 focus:ring-blue-200 outline-none"
                        >
                            {% for value, label in task_priorities %}
                                <option value="{{ value }}" {% if task.priority == value %}selected{% endif %}>{{ label }}</option>
                            {% endfor %}
                        </select>
                    </form>
                </div>

                <!-- Assignee -->
                <div class="bg-white rounded-lg shadow p-6">
                    <h3 class="text-sm font-semibold text-gray-700 uppercase mb-3">Assignee</h3>
                    <form method="post">
                        {% csrf_token %}
                        <input type="hidden" name="action" value="assign_task">
                        <select 
                            name="assignee" 
                            onchange="this.form.submit()"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:border-blue-500 focus:ring-2 focus:ring-blue-200 outline-none"
                        >
                            <option value="">-- Unassigned --</option>
                            {% for member in team_members %}
                                <option value="{{ member.id }}" {% if task.assignee.id == member.id %}selected{% endif %}>{{ member.username }}</option>
                            {% endfor %}
                        </select>
                    </form>
                    {% if task.assignee %}
                        <div class="mt-3 text-center">
                            <div class="w-12 h-12 rounded-full bg-gradient-to-r from-blue-500 to-indigo-500 flex items-center justify-center text-white text-lg font-bold mx-auto">
                                {{ task.assignee.username|first|upper }}
                            </div>
                            <p class="text-sm text-gray-900 mt-2">{{ task.assignee.username }}</p>
                        </div>
                    {% endif %}
                </div>

                <!-- Dates -->
                <div class="bg-white rounded-lg shadow p-6">
                    <h3 class="text-sm font-semibold text-gray-700 uppercase mb-4">Timeline</h3>
                    <div class="space-y-3 text-sm">
                        {% if task.start_date %}
                            <div>
                                <p class="text-gray-600">Start Date</p>
                                <p class="font-semibold text-gray-900">{{ task.start_date|date:"M d, Y" }}</p>
                            </div>
                        {% endif %}
                        
                        {% if task.due_date %}
                            <div>
                                <p class="text-gray-600">Due Date</p>
                                <p class="font-semibold text-gray-900">{{ task.due_date|date:"M d, Y" }}</p>
                            </div>
                        {% endif %}

                        <div class="pt-3 border-t border-gray-200">
                            <p class="text-gray-600">Created</p>
                            <p class="font-semibold text-gray-900">{{ task.created_at|date:"M d, Y" }}</p>
                        </div>

                        {% if task.completed_at %}
                            <div>
                                <p class="text-gray-600">Completed</p>
                                <p class="font-semibold text-gray-900">{{ task.completed_at|date:"M d, Y" }}</p>
                            </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Task Info -->
                <div class="bg-white rounded-lg shadow p-6">
                    <h3 class="text-sm font-semibold text-gray-700 uppercase mb-4">Task Info</h3>
                    <div class="space-y-3 text-sm">
                        <div>
                            <p class="text-gray-600">Created by</p>
                            <p class="font-semibold text-gray-900">{{ task.author.username }}</p>
                        </div>
                        <div>
                            <p class="text-gray-600">Project</p>
                            <p class="font-semibold text-gray-900">{{ task.project.name }}</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}
