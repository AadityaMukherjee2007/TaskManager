<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}{% endblock %}</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    {% csrf_token %}
</head>
<body class="bg-gray-50">
    <div class="flex min-h-screen">
        <!-- Sidebar -->
        <aside class="w-64 bg-white border-r border-gray-200 flex flex-col py-6 px-4 space-y-8">
            <div class="flex items-center gap-3 mb-8">
                <div class="bg-gradient-to-r from-blue-600 to-indigo-600 p-2 rounded-lg shadow-md">
                    <i class="fas fa-tasks text-white text-xl"></i>
                </div>
                <span class="text-2xl font-bold text-gray-800 tracking-tight">TaskManager</span>
            </div>
            <nav class="flex-1 space-y-2">
                <a href="{% url 'dashboard' %}" class="flex items-center gap-3 px-3 py-2 rounded-lg font-medium text-gray-700 hover:bg-blue-50 hover:text-blue-700 transition">
                    <i class="fas fa-home"></i> Dashboard
                </a>
                <a href="{% url 'tasks' %}" class="flex items-center gap-3 px-3 py-2 rounded-lg font-medium text-gray-700 hover:bg-blue-50 hover:text-blue-700 transition">
                    <i class="fas fa-tasks"></i> My Tasks
                </a>
                <a href="{% url 'settings' %}" class="flex items-center gap-3 px-3 py-2 rounded-lg font-medium text-gray-700 hover:bg-blue-50 hover:text-blue-700 transition">
                    <i class="fas fa-cog"></i> Settings
                </a>

                <!-- Teams Sidebar Section -->
                <div class="mt-6">
                    <div class="text-xs font-semibold text-gray-400 uppercase mb-2 tracking-wider">Teams</div>
                    {% if teams and teams|length > 0 %}
                        <ul class="space-y-1">
                            {% for team in teams %}
                                <li class="relative group" oncontextmenu="showTeamMenu(event, {{ team.id }}, '{{ team.name|escapejs }}')">
                                    <a href="{% url 'team_tasks' team.id %}" class="flex items-center gap-2 px-3 py-2 rounded-lg text-gray-700 hover:bg-blue-50 hover:text-blue-700 transition">
                                        <i class="fas fa-users text-blue-400"></i> {{ team.name }}
                                    </a>
                                    <!-- Team Context Menu -->
                                    <div id="team-menu-{{ team.id }}" class="hidden absolute left-32 top-2 z-50 bg-white border border-gray-200 rounded-lg shadow-lg w-40">
                                        <button onclick="openRenameModal('team', {{ team.id }}, '{{ team.name|escapejs }}')" class="w-full text-left px-4 py-2 hover:bg-blue-50">Rename</button>
                                        <button onclick="openDeleteModal('team', {{ team.id }}, '{{ team.name|escapejs }}')" class="w-full text-left px-4 py-2 hover:bg-red-50 text-red-600">Delete</button>
                                    </div>
                                </li>
                            {% endfor %}
                        </ul>
                    {% else %}
                        <div class="text-xs text-gray-400 px-3 py-2">No teams</div>
                    {% endif %}
                    <a href="{% url 'create_team' %}" class="block mt-2 px-3 py-2 rounded-lg text-blue-600 hover:bg-blue-50 font-medium transition text-sm"><i class="fas fa-plus mr-1"></i> Create Team</a>
                </div>

                <!-- Projects Sidebar Section -->
                <div class="mt-6">
                    <div class="text-xs font-semibold text-gray-400 uppercase mb-2 tracking-wider">Projects</div>
                    {% if user_projects and user_projects|length > 0 %}
                        <ul class="space-y-1">
                            {% for project in user_projects %}
                                <li class="relative group" oncontextmenu="showProjectMenu(event, {{ project.id }}, '{{ project.name|escapejs }}')">
                                    <a href="{% url 'project_tasks' project.id %}" class="flex items-center gap-2 px-3 py-2 rounded-lg text-gray-700 hover:bg-blue-50 hover:text-blue-700 transition">
                                        <i class="fas fa-folder text-indigo-400"></i> {{ project.name }}
                                    </a>
                                    <!-- Project Context Menu -->
                                    <div id="project-menu-{{ project.id }}" class="hidden absolute left-32 top-2 z-50 bg-white border border-gray-200 rounded-lg shadow-lg w-40">
                                        <button onclick="openRenameModal('project', {{ project.id }}, '{{ project.name|escapejs }}')" class="w-full text-left px-4 py-2 hover:bg-blue-50">Rename</button>
                                        <button onclick="openDeleteModal('project', {{ project.id }}, '{{ project.name|escapejs }}')" class="w-full text-left px-4 py-2 hover:bg-red-50 text-red-600">Delete</button>
                                    </div>
                                </li>
                            {% endfor %}
                                <!-- Rename/Delete Modal -->
                                <div id="sidebarModal" class="hidden fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50">
                                    <div class="bg-white rounded-2xl shadow-xl p-8 w-full max-w-md relative">
                                        <button onclick="closeSidebarModal()" class="absolute top-3 right-3 text-gray-400 hover:text-red-500 text-xl">&times;</button>
                                        <div id="sidebarModalContent"></div>
                                    </div>
                                </div>

                                <script>
                                // Hide all context menus on click elsewhere
                                document.addEventListener('click', function(e) {
                                    document.querySelectorAll('[id^="team-menu-"], [id^="project-menu-"]').forEach(function(menu) {
                                        menu.classList.add('hidden');
                                    });
                                });
                                function showTeamMenu(e, id, name) {
                                    e.preventDefault();
                                    document.querySelectorAll('[id^="team-menu-"]').forEach(m => m.classList.add('hidden'));
                                    document.getElementById('team-menu-' + id).classList.remove('hidden');
                                }
                                function showProjectMenu(e, id, name) {
                                    e.preventDefault();
                                    document.querySelectorAll('[id^="project-menu-"]').forEach(m => m.classList.add('hidden'));
                                    document.getElementById('project-menu-' + id).classList.remove('hidden');
                                }
                                function openRenameModal(type, id, name) {
                                    closeAllMenus();
                                    let label = type === 'team' ? 'Team' : 'Project';
                                    document.getElementById('sidebarModalContent').innerHTML = `
                                        <h2 class='text-2xl font-bold mb-4 text-gray-900'>Rename ${label}</h2>
                                        <form onsubmit="event.preventDefault(); submitRename('${type}', ${id});">
                                            <input type='text' id='renameInput' class='w-full px-4 py-2 border rounded-lg mb-4' value='${name}' autofocus />
                                            <div class='flex gap-2 justify-end'>
                                                <button type='button' onclick='closeSidebarModal()' class='px-4 py-2 bg-gray-200 text-gray-800 rounded-lg'>Cancel</button>
                                                <button type='submit' class='px-4 py-2 bg-blue-600 text-white rounded-lg'>Rename</button>
                                            </div>
                                        </form>
                                        <div id='renameError' class='text-red-600 mt-2 hidden'></div>
                                    `;
                                    document.getElementById('sidebarModal').classList.remove('hidden');
                                }
                                function openDeleteModal(type, id, name) {
                                    closeAllMenus();
                                    let label = type === 'team' ? 'Team' : 'Project';
                                    document.getElementById('sidebarModalContent').innerHTML = `
                                        <h2 class='text-2xl font-bold mb-4 text-gray-900'>Delete ${label}</h2>
                                        <p class='mb-4'>Are you sure you want to delete <span class='font-semibold'>${name}</span>? This action cannot be undone.</p>
                                        <div class='flex gap-2 justify-end'>
                                            <button type='button' onclick='closeSidebarModal()' class='px-4 py-2 bg-gray-200 text-gray-800 rounded-lg'>Cancel</button>
                                            <button type='button' onclick='submitDelete("${type}", ${id});' class='px-4 py-2 bg-red-600 text-white rounded-lg'>Delete</button>
                                        </div>
                                        <div id='deleteError' class='text-red-600 mt-2 hidden'></div>
                                    `;
                                    document.getElementById('sidebarModal').classList.remove('hidden');
                                }
                                function submitRename(type, id) {
                                    let name = document.getElementById('renameInput').value.trim();
                                    if (!name) {
                                        document.getElementById('renameError').innerText = 'Name cannot be empty.';
                                        document.getElementById('renameError').classList.remove('hidden');
                                        return;
                                    }
                                    let url = type === 'team' ? `/team/${id}/rename` : `/project/${id}/rename`;
                                    fetch(url, {
                                        method: 'POST',
                                        headers: {
                                            'Content-Type': 'application/x-www-form-urlencoded',
                                            'X-CSRFToken': getCSRFToken(),
                                        },
                                        body: `name=${encodeURIComponent(name)}`
                                    })
                                    .then(r => r.json())
                                    .then(data => {
                                        if (data.success) {
                                            // Update sidebar name
                                            if (type === 'team') {
                                                document.querySelectorAll(`[oncontextmenu*="showTeamMenu(event, ${id},"] .flex.items-center.gap-2`).forEach(el => {
                                                    el.childNodes[1].textContent = ' ' + data.name;
                                                });
                                            } else {
                                                document.querySelectorAll(`[oncontextmenu*="showProjectMenu(event, ${id},"] .flex.items-center.gap-2`).forEach(el => {
                                                    el.childNodes[1].textContent = ' ' + data.name;
                                                });
                                            }
                                            closeSidebarModal();
                                        } else {
                                            document.getElementById('renameError').innerText = data.error || 'Error.';
                                            document.getElementById('renameError').classList.remove('hidden');
                                        }
                                    });
                                }
                                function submitDelete(type, id) {
                                    let url = type === 'team' ? `/team/${id}/delete` : `/project/${id}/delete`;
                                    fetch(url, {
                                        method: 'POST',
                                        headers: {
                                            'X-CSRFToken': getCSRFToken(),
                                        }
                                    })
                                    .then(r => r.json())
                                    .then(data => {
                                        if (data.success) {
                                            // Remove sidebar item
                                            if (type === 'team') {
                                                document.querySelectorAll(`[oncontextmenu*="showTeamMenu(event, ${id},"]`).forEach(el => el.remove());
                                            } else {
                                                document.querySelectorAll(`[oncontextmenu*="showProjectMenu(event, ${id},"]`).forEach(el => el.remove());
                                            }
                                            closeSidebarModal();
                                        } else {
                                            document.getElementById('deleteError').innerText = data.error || 'Error.';
                                            document.getElementById('deleteError').classList.remove('hidden');
                                        }
                                    });
                                }
                                function getCSRFToken() {
                                    let cookieValue = null;
                                    if (document.cookie && document.cookie !== '') {
                                        const cookies = document.cookie.split(';');
                                        for (let i = 0; i < cookies.length; i++) {
                                            const cookie = cookies[i].trim();
                                            if (cookie.substring(0, 10) === ('csrftoken=')) {
                                                cookieValue = decodeURIComponent(cookie.substring(10));
                                                break;
                                            }
                                        }
                                    }
                                    return cookieValue;
                                }
                                function closeSidebarModal() {
                                    document.getElementById('sidebarModal').classList.add('hidden');
                                }
                                function closeAllMenus() {
                                    document.querySelectorAll('[id^="team-menu-"], [id^="project-menu-"]').forEach(function(menu) {
                                        menu.classList.add('hidden');
                                    });
                                }
                                </script>
                        </ul>
                    {% else %}
                        <div class="text-xs text-gray-400 px-3 py-2">No projects</div>
                    {% endif %}
                </div>
            </nav>
            <div class="mt-auto">
                <a href="{% url 'logout' %}" class="flex items-center gap-3 px-3 py-2 rounded-lg font-medium text-red-600 hover:bg-red-50 transition">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </a>
            </div>
        </aside>
        <!-- Main Workspace -->
        <div class="flex-1 flex flex-col min-h-screen">
            <!-- Topbar -->
            <header class="h-16 bg-white border-b border-gray-200 flex items-center px-8 justify-end">
                <div class="flex items-center gap-4">
                    <div class="relative" id="user-menu-container">
                        <button type="button" class="flex items-center gap-2 px-3 py-2 rounded-lg hover:bg-gray-100 transition focus:outline-none" id="user-menu-button">
                            {% if request.user.is_authenticated and request.user.profile.avatar %}
                                <img src="{{ request.user.profile.avatar.url }}" alt="Avatar" class="w-8 h-8 rounded-full">
                            {% else %}
                                <i class="fas fa-user-circle text-gray-700 text-2xl"></i>
                            {% endif %}
                            <span class="hidden sm:block text-gray-700 font-medium">{{ request.user.username }}</span>
                            <i class="fas fa-chevron-down ml-1 text-gray-500"></i>
                        </button>
                        <div id="user-dropdown-menu" class="hidden absolute right-0 top-12 w-48 bg-white rounded-lg shadow-lg border border-gray-200 z-50 animate-fade-in">
                            <a href="{% url 'profile' %}" class="block px-4 py-3 text-gray-700 hover:bg-blue-50 transition rounded-t-lg"><i class="fas fa-user mr-2"></i>Profile</a>
                            <a href="{% url 'settings' %}" class="block px-4 py-3 text-gray-700 hover:bg-blue-50 transition"><i class="fas fa-cog mr-2"></i>Settings</a>
                            <div class="border-t border-gray-100"></div>
                            <a href="{% url 'logout' %}" class="block px-4 py-3 text-red-600 hover:bg-red-50 transition rounded-b-lg font-semibold"><i class="fas fa-sign-out-alt mr-2"></i>Logout</a>
                        </div>
                    </div>
                </div>
            </header>
            <!-- Main Content Area -->
            <main class="flex-1 bg-gray-50">
                {% block body %}{% endblock %}
            </main>
        </div>
    </div>
<script>
// User menu dropdown: click to toggle, stays open when moving mouse
document.addEventListener('DOMContentLoaded', function() {
    const btn = document.getElementById('user-menu-button');
    const menu = document.getElementById('user-dropdown-menu');
    const container = document.getElementById('user-menu-container');
    let menuOpen = false;
    if (btn && menu) {
        btn.addEventListener('click', function(e) {
            e.stopPropagation();
            menu.classList.toggle('hidden');
            menuOpen = !menuOpen;
        });
        // Close menu when clicking outside
        document.addEventListener('click', function(e) {
            if (menuOpen && !container.contains(e.target)) {
                menu.classList.add('hidden');
                menuOpen = false;
            }
        });
    }
});
</script>
</body>
</html>
        <footer class="bg-gray-900 text-gray-300 mt-16 border-t border-gray-700">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-8 mb-8">
                    <div>
                        <h3 class="text-white font-semibold mb-4">About TaskManager</h3>
                        <p class="text-sm">A powerful task management platform designed for teams to collaborate efficiently and stay organized.</p>
                    </div>
                    <div>
                        <h3 class="text-white font-semibold mb-4">Quick Links</h3>
                        <ul class="text-sm space-y-2">
                            <li><a href="{% url 'dashboard' %}" class="hover:text-blue-400 transition">Dashboard</a></li>
                            <li><a href="{% url 'tasks' %}" class="hover:text-blue-400 transition">Tasks</a></li>
                            <li><a href="{% url 'settings' %}" class="hover:text-blue-400 transition">Settings</a></li>
                        </ul>
                    </div>
                    <div>
                        <h3 class="text-white font-semibold mb-4">Support</h3>
                        <ul class="text-sm space-y-2">
                            <li><a href="#" class="hover:text-blue-400 transition">Documentation</a></li>
                            <li><a href="#" class="hover:text-blue-400 transition">Contact Us</a></li>
                            <li><a href="#" class="hover:text-blue-400 transition">Report Issue</a></li>
                        </ul>
                    </div>
                </div>
                <div class="border-t border-gray-700 pt-8 text-center">
                    <p>&copy; 2026 TaskManager. All rights reserved. | <a href="#" class="hover:text-blue-400 transition">Privacy Policy</a> | <a href="#" class="hover:text-blue-400 transition">Terms of Service</a></p>
                </div>
            </div>
        </footer>

        <!-- Dark Mode Toggle Script removed -->
    </body>
</html>
